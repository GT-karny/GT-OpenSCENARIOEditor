# Codex Auto-merge Workflow
#
# Codex ãŒ PR ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ãŸçµæœã«å¿œã˜ã¦è‡ªå‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ:
#   - approved   â†’ auto-merge (squash) ã‚’æœ‰åŠ¹åŒ–ï¼ˆCI å®Œäº†å¾…ã¡ï¼‰
#   - ã‚³ãƒ¡ãƒ³ãƒˆ/å¤‰æ›´è¦æ±‚ â†’ "needs-changes" ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸
#
# å‰ææ¡ä»¶ (ãƒªãƒã‚¸ãƒˆãƒªã® Settings ã§æ‰‹å‹•è¨­å®šãŒå¿…è¦):
#   1. Settings > General > "Allow auto-merge" ã‚’ ON ã«ã™ã‚‹
#   2. (æ¨å¥¨) Settings > Branches > Branch protection rule ã§
#      "CI" ã‚’ Required status check ã«è¿½åŠ ã™ã‚‹

name: Codex Auto-merge

on:
  pull_request_review:
    types: [submitted]

env:
  # Codex ã® GitHub ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€‚å¤‰æ›´ãŒã‚ã‚Œã°ã“ã“ã‚’ä¿®æ­£ã™ã‚‹
  CODEX_BOT_USER: chatgpt-codex-connector

permissions:
  contents: write
  pull-requests: write

jobs:
  handle-codex-review:
    name: Handle Codex Review
    runs-on: ubuntu-latest
    if: github.event.review.user.login == 'chatgpt-codex-connector'
    steps:
      - name: Codex approved â€” enable auto-merge
        if: github.event.review.state == 'approved'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… Codex approved PR #${{ github.event.pull_request.number }}"
          gh pr merge ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --squash \
            --auto
          # needs-changes ãƒ©ãƒ™ãƒ«ãŒæ®‹ã£ã¦ã„ãŸã‚‰å¤–ã™
          gh pr edit ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --remove-label "needs-changes" 2>/dev/null || true

      - name: Codex requested changes â€” add label
        if: github.event.review.state == 'changes_requested'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“ Codex requested changes on PR #${{ github.event.pull_request.number }}"
          gh pr edit ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --add-label "needs-changes"

      - name: Codex commented â€” add label
        if: github.event.review.state == 'commented'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ’¬ Codex commented on PR #${{ github.event.pull_request.number }}"
          gh pr edit ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --add-label "needs-changes"
